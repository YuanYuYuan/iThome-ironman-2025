# Zenoh å…§éƒ¨çµæ§‹ï¼šç†è§£ Link Layerï¼ˆé€£çµå±¤ï¼‰

åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å€‘ç°¡å–®æ¢è¨äº† **Zenoh çš„ç¶²è·¯å±¤**ã€‚
ä»Šå¤©ï¼Œæˆ‘å€‘å°‡æ›´å¾€ä¸‹ä¸€å±¤ï¼Œæ·±å…¥äº†è§£ **é€£çµå±¤ï¼ˆLink Layerï¼‰** â€”â€” ç‚º Zenoh ç¯€é»ä¹‹é–“æä¾›é€£ç·šçš„åŸºç¤ã€‚

Zenoh æ©«è·¨è‡ª **è³‡æ–™é€£çµå±¤** ä¸€ç›´åˆ° **æ‡‰ç”¨å±¤**ï¼Œæä¾›ä¸€å€‹çµ±ä¸€çš„é€šè¨Šæ¡†æ¶ã€‚åœ¨é€™å€‹ç³»çµ±çš„æ ¸å¿ƒå°±æ˜¯ **é€£çµå±¤**ï¼Œå®ƒå°‡å„ç¨®ä¸åŒçš„å‚³è¼¸å”å®šç´°ç¯€æŠ½è±¡åŒ–ï¼Œä¸¦ç‚ºæ›´é«˜å±¤å…ƒä»¶æä¾›ä¸€è‡´çš„ä»‹é¢ã€‚

é€£çµå±¤å±•ç¾äº† Zenoh **å‚³è¼¸å”å®šç„¡é—œï¼ˆtransport-agnosticï¼‰** çš„è¨­è¨ˆç†å¿µ â€”â€” ç„¡è«–ä½ æ˜¯é€é TCPã€QUICã€UDP multicastã€WebSocketï¼Œç”šè‡³æ˜¯ Unix ç®¡é“ä¾†é€šè¨Šï¼Œé«˜éš API éƒ½æ˜¯ä¸€è‡´çš„ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Application Layer                          â”‚
â”‚  (Publishers, Subscribers, Querables, Query Clients)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  Session Layer                              â”‚
â”‚        (Session management, Key Expressions)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                 Network Layer                               â”‚
â”‚     (HAT - Hierarchical Abstraction for Transport)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                Transport Layer                              â”‚
â”‚  (Protocol semantics, Batching, Fragmentation)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚                Link Layer           <---- æˆ‘å€‘æ­£åœ¨é€™è£¡  â”‚ â”‚
â”‚ â”‚  (Transport abstraction, link management)               â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚  TCP   â”‚  TLS   â”‚  UDP   â”‚  QUIC  â”‚  WS   â”‚  Serial  â”‚  â”‚ â”‚
â”‚ â”‚  Unix  â”‚  Pipe  â”‚  Vsock â”‚  ...   â”‚       â”‚          â”‚  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              Physical Network Layer                         â”‚
â”‚        (Ethernet, WiFi, Bluetooth, etc.)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä»€éº¼æ˜¯ Zenoh çš„ Link Layerï¼Ÿ

Zenoh çš„é€£çµå±¤ç”±ä¸€ç³»åˆ— **å…§éƒ¨ crate èˆ‡æŠ½è±¡å±¤**ï¼ˆä½æ–¼ `io/zenoh-link*`ï¼‰æ‰€çµ„æˆï¼Œç”¨æ–¼æ”¯æ´å¤šç¨®å‚³è¼¸å”å®šï¼Œä¾‹å¦‚ **TCPã€UDPã€QUICã€TLSã€WebSocketã€Serialã€Unix socketã€vsock** ç­‰ã€‚

é€™ç¨®æŠ½è±¡è¨­è¨ˆè®“ Zenoh **èˆ‡å‚³è¼¸ç„¡é—œ**ï¼šä¸Šå±¤ä¸¦ä¸éœ€è¦çŸ¥é“è³‡æ–™æ˜¯é€é TCP é‚„æ˜¯ QUIC æµå‹•ï¼Œé–‹ç™¼è€…ä¹Ÿå¯ä»¥è¼•é¬†æ–°å¢æ–°çš„Linké¡å‹ã€‚æ¯ç¨®å‚³è¼¸éƒ½å¯¦ä½œåœ¨ç¨ç«‹çš„ crate å…§ï¼ˆå¦‚ `zenoh-link-tcp`, `zenoh-link-quic`ï¼‰ï¼Œä½†éƒ½éµå¾ª `zenoh-link-commons` æ‰€å®šç¾©çš„å…±é€š traitã€‚

ğŸ‘‰ è‹¥è¦äº†è§£å»ºç«‹åœ¨ Link Layer ä¹‹ä¸Šçš„è·¯ç”±æŠ½è±¡ï¼Œè«‹åƒè€ƒ **HAT (Hierarchical Abstraction for Transport)**ã€‚

---

## æ¶æ§‹èˆ‡çµ„ä»¶

é€£çµå±¤æ¡å– **æ¨¡çµ„åŒ–è¨­è¨ˆ**ï¼Œå°‡ **Linkå¯¦ä½œ** èˆ‡ **Linkç®¡ç†** åˆ†é›¢ã€‚

* **Link Trait éšå±¤**
  å®šç¾©æ–¼ `zenoh-link-commons`ï¼Œé€™äº› traitsï¼ˆå¦‚ `LinkUnicastTrait`, `LinkMulticastTrait`ï¼‰è¦ç¯„äº†æ‰€æœ‰å‚³è¼¸é¡å‹çš„å…±é€š APIã€‚

* **Link Manager éšå±¤**
  Link Managerï¼ˆå¦‚ `LinkManagerUnicastTcp`, `LinkManagerMulticastUdp`ï¼‰è² è²¬å»ºç«‹ã€æ¥å—èˆ‡ç¶­è­·é€£ç·šã€‚

* **Link é¡å‹**

  * **å–®æ’­ (Unicast)**ï¼šå…©å€‹ç¯€é»ä¹‹é–“çš„é»å°é»é€šè¨Š

    * å¸¸è¦‹æ“ä½œï¼š`read/write`, `close`, `get_src/get_dst`, `get_mtu`, `is_reliable`, `is_streamed`
  * **å¤šæ’­ (Multicast)**ï¼šä¸€å°å¤šçš„å‚³è¼¸

    * ç›®å‰åƒ…æ”¯æ´ UDP (`LinkMulticastUdp`)
    * ä¸å¯é å‚³è¼¸ï¼Œä½†é©åˆç¾¤çµ„è¨Šæ¯å‚³é

---

## æ”¯æ´çš„å”å®š

Zenoh æ”¯æ´å»£æ³›çš„å‚³è¼¸å”å®šï¼Œæ¯å€‹å”å®šéƒ½æœ‰ä¸åŒçš„å–æ¨ã€‚

| å”å®š                | å¯é æ€§   | å®‰å…¨æ€§   | æµå¼å‚³è¼¸       | å¤šæ’­   | èªè­‰æ–¹å¼ | å°æ‡‰ Crate                     |
| ----------------- | ----- | ----- | ---------- | ---- | ---- | ---------------------------- |
| **TCP**           | âœ… å¯é   | âŒ ç„¡   | âœ… Stream   | âŒ ç„¡  | âŒ ç„¡  | `zenoh-link-tcp`             |
| **TLS**           | âœ… å¯é   | âœ… TLS | âœ… Stream   | âŒ ç„¡  | âœ… æ†‘è­‰ | `zenoh-link-tls`             |
| **UDP**           | âŒ ä¸å¯é  | âŒ ç„¡   | âŒ Datagram | âœ… æ”¯æ´ | âŒ ç„¡  | `zenoh-link-udp`             |
| **QUIC**          | âœ… å¯é   | âœ… TLS | âœ… Stream   | âŒ ç„¡  | âœ… æ†‘è­‰ | `zenoh-link-quic`            |
| **QUIC Datagram** | âŒ ä¸å¯é  | âœ… TLS | âŒ Datagram | âŒ ç„¡  | âœ… æ†‘è­‰ | `zenoh-link-quic-datagram`   |
| **WebSocket**     | âœ… å¯é   | âŒ ç„¡   | âŒ Message  | âŒ ç„¡  | âŒ ç„¡  | `zenoh-link-ws`              |
| **Unix Socket**   | âœ… å¯é   | âŒ ç„¡   | âœ… Stream   | âŒ ç„¡  | âŒ ç„¡  | `zenoh-link-unixsock-stream` |
| **Serial**        | âŒ ä¸å¯é  | âŒ ç„¡   | âŒ Datagram | âŒ ç„¡  | âŒ ç„¡  | `zenoh-link-serial`          |
| **Unix Pipe**     | âœ… å¯é   | âŒ ç„¡   | âœ… Stream   | âŒ ç„¡  | âŒ ç„¡  | `zenoh-link-unixpipe`        |
| **Vsock**         | âœ… å¯é   | âŒ ç„¡   | âœ… Stream   | âŒ ç„¡  | âŒ ç„¡  | `zenoh-link-vsock`           |

---

## å”å®šå¯¦ä½œ

æ¯ç¨®å‚³è¼¸å”å®šçš†é‡å°å…¶ç‰¹æ€§å¯¦ä½œäº†å°ˆå±¬çš„å„ªåŒ–èˆ‡åŠŸèƒ½ï¼š

* **TCP** (`zenoh-link-tcp`)ï¼šå¯é ã€åŸºæ–¼ä¸²æµçš„å‚³è¼¸ï¼Œä½¿ç”¨ `tokio::TcpStream`ã€‚

  * åŠŸèƒ½ï¼šæ”¯æ´ `TCP_NODELAY` ä»¥é™ä½å»¶é²ï¼Œ`TCP_LINGER` è¨­å®šå„ªé›…é—œé–‰è¶…æ™‚
  * æ ¹æ“š IP ç‰ˆæœ¬è¨ˆç®— MTUï¼ˆIPv4: 40-byte æ¨™é ­ï¼ŒIPv6: 60-byte æ¨™é ­ï¼‰
  * Unix ç³»çµ±ä¸Šå¯é€²è¡Œå¹³å°ç‰¹å®šçš„ MSSï¼ˆæœ€å¤§åˆ†æ®µå¤§å°ï¼‰å„ªåŒ–

* **TLS** (`zenoh-link-tls`)ï¼šåœ¨ TCP ä¸Šæä¾›å®‰å…¨å‚³è¼¸ï¼Œä½¿ç”¨ X.509 æ†‘è­‰é©—è­‰ã€‚

  * æ†‘è­‰éˆé©—è­‰åŠéæœŸç›£æ§
  * å¯é…ç½®çš„åŠ å¯†å¥—ä»¶èˆ‡ TLS ç‰ˆæœ¬é¸æ“‡
  * é€éæ†‘è­‰çš„ Common Name é€²è¡Œèº«ä»½é©—è­‰

* **UDP** (`zenoh-link-udp`)ï¼šä¸å¯é çš„è³‡æ–™å ±å‚³è¼¸ï¼Œæ”¯æ´ **å–®æ’­** èˆ‡ **å¤šæ’­**ã€‚

  * å¤šæ’­åŠŸèƒ½ï¼šIPv4/IPv6 ç¾¤çµ„åŠ å…¥/é›¢é–‹ã€TTL è¨­å®šã€ä»‹é¢é¸æ“‡
  * æ”¯æ´ DSCP æ¨™è¨˜ä»¥æå‡ QoSï¼ˆæœå‹™å“è³ªï¼‰
  * å°åŒ…è³‡è¨Šæå–ï¼Œç”¨æ–¼ä»‹é¢ç¶å®š

* **QUIC** (`zenoh-link-quic`)ï¼šåŸºæ–¼ UDP çš„å¯é ã€å®‰å…¨å‚³è¼¸ï¼Œæ”¯æ´å¤šè·¯è¤‡ç”¨ä¸²æµã€‚

  * å…§å»º TLS 1.3 åŠ å¯†èˆ‡æ†‘è­‰é©—è­‰
  * æ”¯æ´é€£ç·šé·ç§»èˆ‡ 0-RTT é€£ç·šå»ºç«‹
  * å–®ä¸€é€£ç·šå…§å¤šè·¯ä¸²æµè¤‡ç”¨

* **WebSocket** (`zenoh-link-ws`)ï¼šåŸºæ–¼ TCP çš„è¨Šæ¯å°å‘å‚³è¼¸ï¼Œä½¿ç”¨ `tokio-tungstenite`ã€‚

  * æ”¯æ´åˆ†å¹€è¨Šæ¯èˆ‡å…§å»ºåˆ†æ®µè™•ç†
  * å¯ç©¿è¶Š HTTP ä»£ç†èˆ‡é˜²ç«ç‰†

* **Unix Domain Socket èˆ‡ Pipe**ï¼šé«˜æ•ˆèƒ½æœ¬æ©Ÿé€²ç¨‹é–“é€šè¨Šï¼ˆIPCï¼‰ã€‚

  * **Unix Socket Stream** (`zenoh-link-unixsock-stream`)ï¼šåŸºæ–¼ä¸²æµçš„ IPC
  * **Unix Pipe** (`zenoh-link-unixpipe`)ï¼šå‘½åç®¡é“ï¼Œç”¨æ–¼è·¨é€²ç¨‹è¨Šæ¯å‚³é

* **Serial** (`zenoh-link-serial`)ï¼šé€éåºåˆ—åŸ é€²è¡ŒåµŒå…¥å¼ç³»çµ±çš„ç›´æ¥é€šè¨Šã€‚

* **Vsock** (`zenoh-link-vsock`)ï¼šè™›æ“¬ Socket ä»‹é¢ï¼Œç”¨æ–¼è™›æ“¬æ©Ÿèˆ‡ Host ä¹‹é–“çš„é€šè¨Šã€‚

---

## ç¨‹å¼ç¢¼é‡é»

ä»¥ä¸‹å±•ç¤º Zenoh åŸå§‹ç¢¼ä¸­ä¸€äº›ç¯„ä¾‹ï¼Œèªªæ˜é€£çµå±¤çš„çµæ§‹èˆ‡ä½¿ç”¨æ–¹å¼ã€‚

### 1. å…±ç”¨é€£çµ Trait èˆ‡å‹åˆ¥

```rust
// æª”æ¡ˆ: io/zenoh-link-commons/src/lib.rs

#[derive(Clone, Debug, Serialize, Hash, PartialEq, Eq)]
pub struct Link {
    pub src: Locator,
    pub dst: Locator,
    pub group: Option<Locator>,
    pub mtu: BatchSize,
    pub is_streamed: bool,
    pub interfaces: Vec<String>,
    pub auth_identifier: LinkAuthId,
    pub priorities: Option<PriorityRange>,
    pub reliability: Option<Reliability>,
}

#[async_trait]
pub trait LocatorInspector: Default {
    fn protocol(&self) -> &str;
    async fn is_multicast(&self, locator: &Locator) -> ZResult<bool>;
    fn is_reliable(&self, locator: &Locator) -> ZResult<bool>;
}
```

æ­¤ç¨‹å¼ç¢¼å®šç¾©äº†æ‰€æœ‰å‚³è¼¸å¯¦ä½œçš„ **å…±ç”¨ç•Œé¢**ã€‚æ¯å€‹ `Link` åŒ…å«ä¾†æº/ç›®çš„å®šä½å™¨ã€MTU è³‡è¨Šã€ä¸²æµç‰¹æ€§èˆ‡èªè­‰ç´°ç¯€ã€‚

---

### 2. å–®æ’­é€£çµ Trait å¯¦ä½œ

```rust
// æª”æ¡ˆ: io/zenoh-link-commons/src/unicast.rs

#[async_trait]
pub trait LinkUnicastTrait: Send + Sync {
    fn get_mtu(&self) -> BatchSize;
    fn get_src(&self) -> &Locator;
    fn get_dst(&self) -> &Locator;
    fn is_reliable(&self) -> bool;
    fn is_streamed(&self) -> bool;
    fn get_interface_names(&self) -> Vec<String>;
    fn get_auth_id(&self) -> &LinkAuthId;
    async fn write(&self, buffer: &[u8]) -> ZResult<usize>;
    async fn write_all(&self, buffer: &[u8]) -> ZResult<()>;
    async fn read(&self, buffer: &mut [u8]) -> ZResult<usize>;
    async fn read_exact(&self, buffer: &mut [u8]) -> ZResult<()>;
    async fn close(&self) -> ZResult<()>;
}
```

æ¯å€‹å–®æ’­é€£çµå¯¦ä½œï¼ˆå¦‚ TCPã€QUICã€TLS ç­‰ï¼‰éƒ½å¿…é ˆå¯¦ä½œæ­¤ Traitï¼Œæä¾›ä¸€å€‹ **çµ±ä¸€ä»‹é¢**ï¼Œä¸è«–åº•å±¤å”å®šç‚ºä½•ã€‚

---

### 3. ä»¥TCP é€£çµå…·é«”å¯¦ä½œçˆ²ä¾‹

```rust
// æª”æ¡ˆ: io/zenoh-links/zenoh-link-tcp/src/unicast.rs

pub struct LinkUnicastTcp {
    socket: UnsafeCell<TcpStream>,
    src_addr: SocketAddr,
    src_locator: Locator,
    dst_addr: SocketAddr,
    dst_locator: Locator,
    mtu: BatchSize,
}

impl LinkUnicastTcp {
    fn new(socket: TcpStream, src_addr: SocketAddr, dst_addr: SocketAddr) -> Self {
        // è¨­å®š TCP NODELAY é¸é …
        socket.set_nodelay(true).unwrap_or_else(|err| {
            tracing::warn!("ç„¡æ³•è¨­å®š NODELAY é¸é …: {}", err);
        });

        // æ ¹æ“š IP ç‰ˆæœ¬è¨ˆç®— MTU
        let header = match src_addr.ip() {
            std::net::IpAddr::V4(_) => 40, // IPv4 + TCP header
            std::net::IpAddr::V6(_) => 60, // IPv6 + TCP header
        };
        let mtu = TCP_DEFAULT_MTU - header;
        // ... å…¶é¤˜åˆå§‹åŒ– ...
    }
}
```

æ¯å€‹å‚³è¼¸å”å®šéƒ½æœƒå¯¦ä½œå…·é«”é€£çµè¡Œç‚ºï¼ŒåŒæ™‚éµå¾ªå…±ç”¨ Traitã€‚

---

### 4. å¤šæ’­é€£çµå¯¦ä½œï¼Œä»¥UDPçˆ²ä¾‹

```rust
// æª”æ¡ˆ: io/zenoh-links/zenoh-link-udp/src/multicast.rs

pub struct LinkMulticastUdp {
    unicast_addr: SocketAddr,
    unicast_locator: Locator,
    unicast_socket: UdpSocket,
    multicast_addr: SocketAddr,
    multicast_locator: Locator,
    mcast_sock: UdpSocket,
}

#[async_trait]
impl LinkMulticastTrait for LinkMulticastUdp {
    async fn close(&self) -> ZResult<()> {
        match self.multicast_addr.ip() {
            IpAddr::V4(dst_ip4) => {
                self.mcast_sock.leave_multicast_v4(dst_ip4, src_ip4)
            },
            IpAddr::V6(dst_ip6) => {
                self.mcast_sock.leave_multicast_v6(&dst_ip6, 0)
            }
        }
        // ... éŒ¯èª¤è™•ç† ...
    }
}
```

**UDP å¤šæ’­** éœ€è¦ç‰¹åˆ¥è™•ç†ç¾¤çµ„æˆå“¡è³‡æ ¼ï¼Œä¸”å–®æ’­èˆ‡å¤šæ’­æ“ä½œä½¿ç”¨ä¸åŒçš„ socketã€‚

---

### 5. é€£çµç®¡ç†æ¨¡å¼

```rust
// æª”æ¡ˆ: io/zenoh-link-commons/src/unicast.rs

pub type LinkManagerUnicast = Arc<dyn LinkManagerUnicastTrait>;

#[async_trait]
pub trait LinkManagerUnicastTrait: Send + Sync {
    async fn new_link(&self, endpoint: EndPoint) -> ZResult<LinkUnicast>;
    async fn new_listener(&self, endpoint: EndPoint) -> ZResult<Locator>;
    async fn del_listener(&self, endpoint: &EndPoint) -> ZResult<()>;
    async fn get_listeners(&self) -> Vec<EndPoint>;
    async fn get_locators(&self) -> Vec<Locator>;
}

// ç¯„ä¾‹: TCP é€£çµç®¡ç†å™¨å¯¦ä½œ
impl LinkManagerUnicastTrait for LinkManagerUnicastTcp {
    async fn new_link(&self, endpoint: EndPoint) -> ZResult<LinkUnicast> {
        let addrs = get_tcp_addrs(endpoint.address()).await?;
        let stream = TcpStream::connect(addr).await?;
        let link = LinkUnicastTcp::new(stream, src_addr, dst_addr);
        Ok(LinkUnicast::from(Arc::new(link)))
    }
}
```

**é€£çµç®¡ç†å™¨**è² è²¬ç®¡ç†é€£ç·šç”Ÿå‘½é€±æœŸï¼šå»ºç«‹å¤–éƒ¨é€£çµã€è¨­å®šç›£è½å™¨ä»¥æ¥å—é€²ä¾†çš„é€£ç·šï¼Œä»¥åŠç®¡ç†æ´»èºç›£è½å™¨çš„ç™»éŒ„ã€‚æ¯å€‹å‚³è¼¸å”å®šéƒ½æœ‰è‡ªå·±çš„ç®¡ç†å™¨å¯¦ä½œã€‚

> é †å¸¶ä¸€æï¼Œé€™é‚Šä½¿ç”¨çš„sync_traitè‡ªRust 1.75ç™¼ä½ˆä¹‹å¾Œå…¶å¯¦å°±å·²ç¶“å…§å»ºäº†ï¼Œå¯è¦‹å…¶æ­·å²çš„ç—•è·¡XDã€‚

---

## æ•´åˆè‡³å‚³è¼¸å±¤

**å‚³è¼¸å±¤** é€éå®Œå–„çš„ä»‹é¢ä½¿ç”¨ **é€£çµå±¤** çš„æŠ½è±¡æ¦‚å¿µï¼š

```rust
// æª”æ¡ˆï¼šio/zenoh-transport/src/unicast/link.rs

pub(crate) struct TransportLinkUnicast {
    pub(crate) link: LinkUnicast,
    pub(crate) config: TransportLinkUnicastConfig,
}

impl TransportLinkUnicast {
    pub(crate) async fn send(&self, msg: &TransportMessage) -> ZResult<usize> {
        // å°‡è¨Šæ¯åºåˆ—åŒ–ä¸¦å¯«å…¥åº•å±¤é€£çµ
        let mut link = self.tx();
        link.send(msg).await
    }

    pub(crate) async fn recv(&self) -> ZResult<TransportMessage> {
        // å¾é€£çµè®€å–ä¸¦å°‡è¨Šæ¯ååºåˆ—åŒ–
        let mut link = self.rx();
        link.recv().await
    }
}
```

**å‚³è¼¸ç®¡ç†å™¨(Transport Manager)** ä½¿ç”¨é€£çµå±¤ä¾†ï¼š

  * å»ºç«‹èˆ‡é ç«¯ç¯€é»çš„ **é€£ç·š**ï¼Œä¸¦ä½¿ç”¨é©ç•¶çš„é€£çµç®¡ç†å™¨
  * åŒæ™‚**ç›£è½**ä¸¦**æ¥å—**å¤šå€‹å‚³è¼¸ä¸Šçš„å‚³å…¥é€£ç·š
  * é€éé€£çµ**å‚³é€/æ¥æ”¶** Zenoh å”å®šè¨Šæ¯ï¼ˆä¾‹å¦‚ï¼šè³‡æ–™ã€æŸ¥è©¢ã€å›è¦†ï¼‰
  * **ç›£æ§é€£çµå¥åº·ç‹€æ…‹**ä¸¦é€æ˜åœ°è™•ç†é€£ç·šå¤±æ•—
  * **æ‰¹æ¬¡æœ€ä½³åŒ–**ï¼šé‡å°æ¯ç¨®é€£çµé¡å‹é…ç½® MTU å’Œæ‰¹æ¬¡è™•ç†ç­–ç•¥

é€™ç¨®åˆ†é›¢è®“å‚³è¼¸å±¤èƒ½å°ˆæ³¨æ–¼**Zenoh å”å®šèªç¾©**ï¼ˆè·¯ç”±ã€åˆ†æ®µã€å£…å¡æ§åˆ¶ï¼‰ï¼Œè€Œé€£çµå±¤å‰‡è² è²¬è™•ç†ç¶²è·¯é€£ç·šã€é€šè¨Šç«¯é…ç½®ä»¥åŠå”å®šç‰¹å®šæœ€ä½³åŒ–çš„åº•å±¤ç´°ç¯€ã€‚

é€™æ¨£çš„è¨­è¨ˆè®“ **Transport Layer** å°ˆæ³¨æ–¼ **Zenoh å”å®šé‚è¼¯**ï¼Œè€Œ **Link Layer** å‰‡è² è²¬åº•å±¤ç¶²è·¯ç´°ç¯€ã€‚
ç­†è€…å°‡åœ¨å¾ŒçºŒçš„æ–‡ç« ä¸­å†é€²ä¸€æ­¥è¨è«–ç´°ç¯€ï¼Œæ•¬è«‹æœŸå¾…ï¼

---

## ä½¿ç”¨ç¯„ä¾‹

ä»¥ä¸‹å±•ç¤º Zenoh æ‡‰ç”¨ä¸­ï¼Œä¸åŒ Link Layer å‚³è¼¸æ–¹å¼çš„å¯¦éš›ä½¿ç”¨æ–¹æ³•ï¼š

### TCP å‚³è¼¸

```bash
# å•Ÿå‹•ä¸€å€‹ TCP è¨‚é–±è€…
z_sub --listen tcp/127.0.0.1:7447 --key "demo/example"

# é€é TCP é€£æ¥ç™¼ä½ˆè€…
z_pub --connect tcp/127.0.0.1:7447 --key "demo/example" --value "Hello via TCP!"
```

### QUIC

```bash
# QUIC è¨‚é–±è€…ä½¿ç”¨ TLS
z_sub --listen quic/127.0.0.1:7447 --key "demo/secure"

# QUIC ç™¼ä½ˆè€…
z_pub --connect quic/127.0.0.1:7447 --key "demo/secure" --value "Secure message"
```

### Unix Domain Socketï¼ˆæœ¬åœ° IPCï¼‰

```bash
# Unix socket è¨‚é–±è€…
z_sub --listen unixsock-stream//tmp/zenoh.sock --key "demo/local"

# Unix socket ç™¼ä½ˆè€…
z_pub --connect unixsock-stream//tmp/zenoh.sock --key "demo/local" --value "Local IPC"
```

### åŒæ™‚ä½¿ç”¨å¤šç¨®å‚³è¼¸

```bash
# åŒæ™‚ç›£è½å¤šç¨®å‚³è¼¸
z_sub --listen tcp/127.0.0.1:7447 \
      --listen udp/224.0.0.1:7448 \
      --listen ws/127.0.0.1:8080 \
      --key "demo/**"

# ç™¼ä½ˆè€…å¯ä»¥é€£æ¥ä»»æ„ä¸€ç¨®å‚³è¼¸
z_pub --connect tcp/127.0.0.1:7447 --key "demo/tcp" --value "TCP message"
z_pub --connect udp/224.0.0.1:7448 --key "demo/udp" --value "UDP message"
z_pub --connect ws/127.0.0.1:8080 --key "demo/ws" --value "WebSocket message"
```

Zenoh Link Layer çš„ **ç²¾é«“** åœ¨æ–¼ï¼Œåˆ‡æ›å‚³è¼¸æ–¹å¼åªéœ€æ›´æ”¹ Locator å­—ä¸²ï¼Œè€Œæ‡‰ç”¨ç¨‹å¼ç¨‹å¼ç¢¼ä¿æŒä¸è®Šï¼

---

## åŠŸèƒ½é–˜èˆ‡é…ç½®

Zenoh Link Layer å‚³è¼¸é€é **Cargo åŠŸèƒ½æ¨™èªŒï¼ˆfeature flagsï¼‰** æ§åˆ¶ï¼Œè®“ä½ åªç·¨è­¯æ‰€éœ€çš„å‚³è¼¸æ–¹å¼ï¼Œæ¸›å°‘äºŒé€²ä½æª”å¤§å°ä¸¦æ¶ˆé™¤ä¸å¿…è¦çš„ä¾è³´ã€‚

### é è¨­åŠŸèƒ½ï¼ˆé è¨­å•Ÿç”¨ï¼‰

```toml
# æª”æ¡ˆ: zenoh/Cargo.toml

[features]
default = [
  "auth_pubkey",
  "auth_usrpwd",
  "transport_compression",
  "transport_multilink",
  "transport_quic",
  "transport_quic_datagram",
  "transport_tcp",
  "transport_tls",
  "transport_udp",
  "transport_unixsock-stream",
  "transport_ws",
]
```

### æ‰€æœ‰å‚³è¼¸åŠŸèƒ½

```toml
# å€‹åˆ¥å‚³è¼¸åŠŸèƒ½
transport_tcp = ["zenoh-config/transport_tcp", "zenoh-transport/transport_tcp"]
transport_udp = ["zenoh-transport/transport_udp"]
transport_quic = ["zenoh-transport/transport_quic"]
transport_quic_datagram = ["zenoh-transport/transport_quic_datagram"]
transport_tls = ["zenoh-transport/transport_tls"]
transport_ws = ["zenoh-transport/transport_ws"]
transport_serial = ["zenoh-transport/transport_serial"]
transport_unixpipe = ["zenoh-transport/transport_unixpipe"]
transport_unixsock-stream = ["zenoh-transport/transport_unixsock-stream"]
transport_vsock = ["zenoh-transport/transport_vsock"]

# é¡å¤–å‚³è¼¸åŠŸèƒ½
transport_compression = ["zenoh-transport/transport_compression"]
transport_multilink = ["zenoh-transport/transport_multilink"]
```

### è‡ªè¨‚å»ºç½®ç¯„ä¾‹

**åƒ… TCP çš„æœ€å°å»ºç½®**ï¼ˆé©ç”¨æ–¼åµŒå…¥å¼æˆ–è³‡æºå—é™ç’°å¢ƒï¼‰ï¼š

```bash
cargo build --no-default-features --features "transport_tcp"
```

**åƒ…å®‰å…¨å‚³è¼¸**ï¼ˆé©ç”¨æ–¼å®‰å…¨æ•æ„Ÿçš„æ‡‰ç”¨ï¼‰ï¼š

```bash
cargo build --no-default-features --features "transport_tls,transport_quic"
```

**åŒ…å«æ‰€æœ‰å‚³è¼¸åŠå¯¦é©—æ€§åŠŸèƒ½**ï¼ˆé©ç”¨æ–¼é–‹ç™¼/æ¸¬è©¦ï¼‰ï¼š

```bash
cargo build --features "transport_serial,transport_vsock,transport_unixpipe"
```

é€™å€‹ **æ¨¡çµ„åŒ–åŠŸèƒ½ç³»çµ±** ä½¿ Zenoh å¯ä»¥å¾å°å‹åµŒå…¥å¼è¨­å‚™ï¼ˆå¦‚åƒ…ä½¿ç”¨ `transport_serial`ï¼‰æ“´å±•åˆ°å¤§å‹åˆ†æ•£å¼ç³»çµ±ï¼ˆå¦‚ä½¿ç”¨æ‰€æœ‰å¯ç”¨å‚³è¼¸ï¼‰ã€‚

---

## èªè­‰èˆ‡å®‰å…¨æ€§

æƒ³äº†è§£å¦‚ä½•åœ¨ Zenoh ä¸­ä½¿ç”¨ TLS æˆ– QUICï¼Œè«‹åƒè€ƒ [å®˜æ–¹æ–‡ä»¶](https://zenoh.io/docs/manual/tls/)ã€‚

---

## ç¸½çµ

Zenoh Link Layer æ˜¯ï¼š

* å°å„ç¨®ç¶²è·¯å”è­°çš„ **çµ±ä¸€æŠ½è±¡**ã€‚
* **æ¨¡çµ„åŒ–**ï¼šæ¯å€‹å”è­°å„è‡ªå°è£æ–¼ç¨ç«‹ crate ä¸­ï¼Œçš†éµå¾ªå…±ç”¨ traitã€‚
* **å¯æ“´å±•**ï¼šå¯æ–°å¢å‚³è¼¸æ–¹å¼è€Œä¸å½±éŸ¿ä¸Šå±¤ç¨‹å¼ç¢¼ã€‚
* **åŸºç¤æ€§**ï¼šæ”¯æ’å‚³è¼¸å±¤ï¼Œé€²è€Œæ”¯æ’æ•´å€‹ Zenohã€‚

é€ééš±è—å‚³è¼¸å±¤è¤‡é›œæ€§ï¼ŒLink Layer ä½¿ Zenoh å¯é‹ä½œæ–¼å¤šç¨®ç’°å¢ƒ â€” å¾æœ¬åœ°é€²ç¨‹é–“é€šè¨Šåˆ°å¤§å‹åˆ†æ•£å¼ç¶²è·¯ã€‚
