# ğŸ¦€ æ‰“é€ å„ç¨®ç¶²è·¯æ‹“æ’²çš„Zenoh å¾®æœå‹™

åœ¨é€™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å€‘å°‡æŠŠå–®ä¸€ç¯€é»çš„å¾®æœå‹™æ“´å±•æˆä¸€å€‹å¤šé€²ç¨‹æ‡‰ç”¨ç¨‹å¼ã€‚é€™å°‡è®“æˆ‘å€‘é«”é©— Zenoh åœ¨**æœå‹™ç™¼ç¾**èˆ‡**å¯æ“´å±•æ€§**ä¸Šçš„å¼·å¤§åŠŸèƒ½ã€‚

æˆ‘å€‘å°‡å»ºç«‹äº”å€‹ç¨ç«‹çš„å¯åŸ·è¡Œæª”ï¼ˆbinariesï¼‰ï¼š

* `echo_service`ï¼šä¸€å€‹ç°¡å–®çš„æœå‹™ï¼Œæœƒå›æ‡‰æ¥æ”¶åˆ°çš„ä»»ä½•è¨Šæ¯ã€‚
* `convert_service`ï¼šå°‡æ•´æ•¸è½‰æ›æˆäºŒé€²ä½è¡¨ç¤ºçš„æœå‹™ã€‚
* `sensor_publisher`ï¼šæ¨¡æ“¬æº«åº¦æ„Ÿæ¸¬å™¨ä¸¦å®šæœŸç™¼å¸ƒè³‡æ–™çš„ç™¼ä½ˆè€…ã€‚
* `sensor_subscriber`ï¼šè¨‚é–±ä¸¦æ¥æ”¶æº«åº¦æ›´æ–°çš„è¨‚é–±è€…ã€‚
* `client`ï¼šå®šæœŸæŸ¥è©¢ `echo` å’Œ `convert` æœå‹™çš„å®¢æˆ¶ç«¯ã€‚

æˆ‘å€‘å°‡æ¢è¨å¾®æœå‹™çš„ä¸‰ç¨®ä¸åŒé‹è¡Œæƒ…å¢ƒï¼š

1. **é»å°é»æ¨¡å¼ï¼ˆPeer-to-Peer Modeï¼‰**ï¼šæœå‹™é€éå¤šæ’­è‡ªå‹•åœ¨ç¶²è·¯ä¸­ç™¼ç¾å½¼æ­¤ã€‚
2. **è·¯ç”±æ¨¡å¼ï¼ˆRouter Modeï¼‰**ï¼šé€éä¸­å¤® `zenohd` è·¯ç”±å™¨é€²è¡Œæœå‹™ç™¼ç¾ï¼Œä½†é€šè¨Šä»æ˜¯é»å°é»ã€‚
3. **è·¨ç¶²è·¯é€šè¨Šï¼ˆMulti-Network Communicationï¼‰**ï¼šä¸åŒç¶²è·¯ä¸­çš„æœå‹™é€éå…¬å…±è·¯ç”±å™¨äº’ç›¸é€šè¨Šã€‚

---

## å°ˆæ¡ˆè¨­å®š

æˆ‘å€‘å°‡æ²¿ç”¨å‰ä¸€ç« å»ºç«‹çš„ `micro-service` å°ˆæ¡ˆï¼Œä¸¦æŠŠæ–°çš„å¯åŸ·è¡Œæª”æ”¾åœ¨ `src/bin` ç›®éŒ„ä¸‹ã€‚

### `Cargo.toml`

è«‹ç¢ºä¿ä½ çš„ `Cargo.toml` æª”æ¡ˆåŒ…å«ä»¥ä¸‹ç›¸ä¾å¥—ä»¶èˆ‡ binary å®šç¾©ï¼š

---


```toml
[package]
name = "mirco-service"
version = "0.1.0"
edition = "2024"

[dependencies]
zenoh = "1.5.1"
tokio = { version = "1", features = ["full"] }

[[bin]]
name = "echo_service"
path = "src/bin/echo_service.rs"

[[bin]]
name = "convert_service"
path = "src/bin/convert_service.rs"

[[bin]]
name = "sensor_publisher"
path = "src/bin/sensor_publisher.rs"

[[bin]]
name = "sensor_subscriber"
path = "src/bin/sensor_subscriber.rs"

[[bin]]
name = "client"
path = "src/bin/client.rs"
```

---

## Case 1: Peer-to-Peer Mode (Multicast Discovery)

åœ¨æ­¤æ¨¡å¼ä¸‹ï¼Œæ¯å€‹ Zenoh ç¯€é»æœƒä½¿ç”¨å¤šæ’­ä¾†ç™¼ç¾åŒä¸€ç¶²è·¯ä¸­çš„å…¶ä»–ç¯€é»ã€‚
é€™æ˜¯é è¨­è¡Œç‚ºï¼Œä¸éœ€è¦ä»»ä½•ä¸­é–“çš„routerã€‚

### Diagram: Peer-to-Peer Discovery

```
                      +------------------+
                      | Network (LAN)    |
                      +------------------+
                        ^    ^    ^    ^
                        |    |    |    | Multicast Discovery
+-----------------+     |    |    |    |     +--------------------+
|  echo_service   |<----/    |    |    \---->|  sensor_publisher  |
+-----------------+          |    |          +--------------------+
                             |    |
+------------------+         |    |         +---------------------+
| convert_service  |<-------/     \-------->|  sensor_subscriber  |
+------------------+                        +---------------------+
        ^                                           ^
        |
        \------------------------------------------/
                           |
                   +--------------+
                   |    client    |
                   +--------------+
```

### ç¨‹å¼ç¢¼

ä»¥ä¸‹æ˜¯æ¯å€‹æª”æ¡ˆçš„ç¨‹å¼ç¢¼ç¯„ä¾‹ã€‚

#### `echo_service.rs`

```rust
use zenoh::Config;

#[tokio::main]
async fn main() {
    let session = zenoh::open(Config::default()).await.unwrap();
    println!("Echo service started!");

    let echo = session.declare_queryable("service/echo").await.unwrap();
    tokio::spawn(async move {
        while let Ok(query) = echo.recv_async().await {
            let msg = query.payload()
                .map(|p| p.try_to_string().unwrap_or_default())
                .unwrap_or_default();
            println!("[Echo service] Received request: {}", msg);
            query.reply(query.key_expr().clone(), format!("Echo: {}", msg)).await.unwrap();
        }
    });

    loop { tokio::time::sleep(std::time::Duration::from_secs(60)).await; }
}
```

#### `convert_service.rs`

```rust
use zenoh::Config;

#[tokio::main]
async fn main() {
    let session = zenoh::open(Config::default()).await.unwrap();
    println!("Convert service started!");

    let convert = session.declare_queryable("service/convert").await.unwrap();
    tokio::spawn(async move {
        while let Ok(query) = convert.recv_async().await {
            let msg = query.payload()
                .map(|p| p.try_to_string().unwrap_or_default())
                .unwrap_or_default();
            println!("[Convert service] Received request: {}", msg);
            let reply = msg.parse::<i64>()
                .map(|v| format!("0b{:b}", v))
                .unwrap_or_else(|_| "Error: not an integer".into());
            query.reply(query.key_expr().clone(), reply).await.unwrap();
        }
    });

    loop { tokio::time::sleep(std::time::Duration::from_secs(60)).await; }
}
```

#### `sensor_publisher.rs`

```rust
use zenoh::Config;
use tokio::time::{sleep, Duration};

#[tokio::main]
async fn main() {
    let session = zenoh::open(Config::default()).await.unwrap();
    let publisher = session.declare_publisher("sensor/temperature").await.unwrap();
    let mut value = 25.0;

    loop {
        let msg = format!("Temp = {:.1}", value);
        publisher.put(msg.clone()).await.unwrap();
        println!("[Publisher] {}", msg);
        value += 0.1;
        sleep(Duration::from_secs(2)).await;
    }
}
```

#### `sensor_subscriber.rs`

```rust
use zenoh::Config;

#[tokio::main]
async fn main() {
    let session = zenoh::open(Config::default()).await.unwrap();
    let subscriber = session.declare_subscriber("sensor/**").await.unwrap();

    while let Ok(sample) = subscriber.recv_async().await {
        let payload = sample.payload().try_to_string().unwrap_or_default().to_string();
        println!("[Subscriber] '{}' -> {}", sample.key_expr(), payload);
    }
}
```

#### `client.rs`

```rust
use zenoh::Config;
use tokio::time::{sleep, Duration};

#[tokio::main]
async fn main() {
    let session = zenoh::open(Config::default()).await.unwrap();
    sleep(Duration::from_secs(5)).await; // wait for services

    let mut counter = 0;
    loop {
        counter += 1;
        let replies = session.get("service/echo")
            .payload(format!("Hello Zenoh! #{}", counter))
            .await.unwrap();
        while let Ok(reply) = replies.recv_async().await {
            if let Ok(sample) = reply.result() {
                println!("[Client] Echo reply: {}", sample.payload().try_to_string().unwrap());
            }
        }

        let test_value = 42 + counter;
        let replies = session.get("service/convert")
            .payload(test_value.to_string())
            .await.unwrap();
        while let Ok(reply) = replies.recv_async().await {
            if let Ok(sample) = reply.result() {
                println!("[Client] Convert reply: {}", sample.payload().try_to_string().unwrap());
            }
        }

        sleep(Duration::from_secs(3)).await;
    }
}
```

### åŸ·è¡Œæ–¹å¼

é–‹å•Ÿäº”å€‹ä¸åŒçš„çµ‚ç«¯æ©Ÿï¼Œä¸¦åˆ†åˆ¥åŸ·è¡Œæ¯å€‹ç¨‹å¼ï¼š

```bash
cargo run --bin echo_service
cargo run --bin convert_service
cargo run --bin sensor_publisher
cargo run --bin sensor_subscriber
cargo run --bin client
```

é€™äº›ç¯€é»å°‡é€éå¤šæ’­è‡ªå‹•äº’ç›¸ç™¼ç¾ï¼Œæ‚¨å°‡çœ‹åˆ° client èˆ‡æœå‹™äº’å‹•ï¼Œä»¥åŠ subscriber æ¥æ”¶ä¾†è‡ª publisher çš„è³‡æ–™ã€‚

---

## Case 2: Router Mode (`zenohd`)

åœ¨æ­¤æ¨¡å¼ä¸‹ï¼Œæˆ‘å€‘ä½¿ç”¨ä¸€å€‹ `zenohd` å¯¦ä¾‹ä½œç‚ºé›†ä¸­å¼è·¯ç”±å™¨ä¾†é€²è¡Œæœå‹™ç™¼ç¾ã€‚é€™åœ¨è¼ƒå¤§è¦æ¨¡çš„éƒ¨ç½²ä¸­ï¼Œæˆ–ç•¶å¤šæ’­ä¸å¯ç”¨æˆ–ä¸é©åˆä½¿ç”¨æ™‚ç‰¹åˆ¥æœ‰ç”¨ã€‚

### Diagram: Router Mode

```
+-----------------+      +--------------------+      +---------------------+
|  echo_service   |      |  convert_service   |      |  sensor_publisher   |
+-----------------+      +--------------------+      +---------------------+
        |                        |                             |
        \------------------------|----------------------------/
                                 |
                      +------------------+
                      |  Zenoh Router    |
                      | (`zenohd`)       |
                      +------------------+
                                 |
        /------------------------|----------------------------\
        |                        |                             |
+-----------------+      +--------------------+      +---------------------+
|     client      |      | sensor_subscriber  |      | (other services)    |
+-----------------+      +--------------------+      +---------------------+
```

### å¦‚ä½•åŸ·è¡Œ

1. **å•Ÿå‹• Zenoh è·¯ç”±å™¨**

   é¦–å…ˆï¼Œä½ éœ€è¦å®‰è£ `zenohd`ã€‚å¦‚æœå°šæœªå®‰è£ï¼Œå¯ä»¥å¾ [Zenoh å®˜æ–¹ç¶²ç«™](https://download.eclipse.org/zenoh/zenoh/latest/) ä¸‹è¼‰ã€‚

   åŸ·è¡Œä»¥ä¸‹å‘½ä»¤å•Ÿå‹•è·¯ç”±å™¨ï¼š

   ```bash
   zenohd --listen tcp/0.0.0.0:7447
   ```

2. **ä¿®æ”¹ç¨‹å¼ç¢¼**

   åœ¨äº”å€‹åŸ·è¡Œæª”ä¸­ï¼Œä¿®æ”¹ Zenoh session è¨­å®šä»¥é€£æ¥åˆ°è·¯ç”±å™¨ï¼š

   ```rust
   let config = Config::from_file("config.json5").unwrap();
   let session = zenoh::open(config).await.unwrap();
   ```

   _config.json5_
   ```json
   {
     connect: {
       endpoints: [
         "tcp/127.0.0.1:7447"
       ],
     },
     scouting: {
       multicast: {
         enabled: false,
       }
     }
   }
   ```

3. **åŸ·è¡Œå„å€‹åŸ·è¡Œæª”**

   æ¥ä¸‹ä¾†ï¼Œåœ¨ä¸åŒçš„çµ‚ç«¯æ©Ÿä¸­é‹è¡Œäº”å€‹åŸ·è¡Œæª”ã€‚å®ƒå€‘æœƒé€éè·¯ç”±å™¨é€²è¡Œæœå‹™ç™¼ç¾ï¼Œç„¶å¾Œç›¸äº’é€šä¿¡ã€‚ä¸€æ—¦å»ºç«‹é€£æ¥å¾Œï¼Œå°±ç®—ä¸­é–“çš„zenohdæ–·æ‰äº†ä¹Ÿé‚„æ˜¯å¯ä»¥æ­£å¸¸é€šè¨Šã€‚

---

## æ¡ˆä¾‹ 3ï¼šè·¨å¤šç¶²è·¯çš„é€šè¨Šï¼ˆä½¿ç”¨å…¬å…±è·¯ç”±å™¨ï¼‰

Zenoh çš„è·¯ç”±å™¨æ¨¡å¼éå¸¸é©åˆæœå‹™åˆ†æ•£åœ¨ä¸åŒç¶²è·¯çš„æƒ…å¢ƒã€‚åªè¦æ¯å€‹æœå‹™èƒ½å¤ é€£æ¥åˆ°è·¯ç”±å™¨çš„å…¬å…± IP ä½å€ï¼Œå®ƒå€‘å°±å¯ä»¥ç›¸äº’é€šä¿¡ã€‚

### Diagram: Multi-Network Communication

```
+-----------------+      +--------------------+
|    Machine 1    |      |   Public Internet  |
| (Network A)     |      |                    |
+-----------------+      +--------------------+
|                 |      |                    |
| +-------------+ |      |  +---------------+ |
| | echo_service| |<------>| Zenoh Router  |<------>
| +-------------+ |      |  |(Public IP)    | |
|                 |      |  +---------------+ |
| +-------------+ |      |                    |
| | client      | |<------>                  |
| +-------------+ |      |                    |
+-----------------+      +--------------------+
                         ^
                         |
+-----------------+      |
|    Machine 2    |      |
| (Network B)     |      |
+-----------------+      |
|                 |      |
| +-------------+ |      |
| |convert_service| -----/
| +-------------+ |
|                 |
| +-------------+ |
| |sensor_pub   | | -----\
| +-------------+ |      |
|                 |      |
| +-------------+ |      |
| |sensor_sub   | | <----/
| +-------------+ |
+-----------------+
```

### åŸ·è¡Œæ–¹å¼

1. **åœ¨å…¬å…±ä¼ºæœå™¨å•Ÿå‹• Zenoh è·¯ç”±å™¨**

   ä½ éœ€è¦ä¸€å°å…·æœ‰å…¬å…± IP ä½å€çš„ä¼ºæœå™¨ï¼ˆä¾‹å¦‚é›²ç«¯ä¼ºæœå™¨ï¼‰ã€‚å‡è¨­å…¬å…± IP æ˜¯ `203.0.113.1`ï¼Œåœ¨æ­¤ä¼ºæœå™¨ä¸Šå•Ÿå‹•è·¯ç”±å™¨ï¼š

   ```bash
   zenohd --listen tcp/0.0.0.0:7447
   ```

2. **åœ¨æ©Ÿå™¨ 1ï¼ˆç¶²è·¯ Aï¼‰é…ç½®ä¸¦åŸ·è¡Œæœå‹™**

   åœ¨ç¬¬ä¸€å°æ©Ÿå™¨ä¸Šï¼Œä¿®æ”¹ `echo_service` å’Œ `client` çš„ç¨‹å¼ç¢¼ï¼Œè®“å®ƒå€‘é€£æ¥åˆ°å…¬å…±è·¯ç”±å™¨ï¼š

   ```rust
   let config = Config::from_file("config.json5").unwrap();
   let session = zenoh::open(config).await.unwrap();
   ```

   _config.json5_
   ```json
   {
     connect: {
       endpoints: [
         "tcp/203.0.113.1:7447"
       ],
     },
     scouting: {
       multicast: {
         enabled: false,
       }
     }
   }
   ```

   ç„¶å¾ŒåŸ·è¡Œæœå‹™ï¼š

   ```bash
   cargo run --bin echo_service
   cargo run --bin client
   ```

3. **åœ¨æ©Ÿå™¨ 2ï¼ˆç¶²è·¯ Bï¼‰é…ç½®ä¸¦åŸ·è¡Œæœå‹™**

   åœ¨ç¬¬äºŒå°æ©Ÿå™¨ä¸Šï¼Œä¿®æ”¹ `convert_service`ã€`sensor_publisher` å’Œ `sensor_subscriber` çš„ç¨‹å¼ç¢¼ï¼Œé€£æ¥åˆ°ç›¸åŒçš„å…¬å…±è·¯ç”±å™¨ï¼š

   ```rust
   let mut config = Config::default();
   config.connect.push("tcp/203.0.113.1:7447".to_string());
   let session = zenoh::open(config).await.unwrap();
   ```

   ç„¶å¾ŒåŸ·è¡Œæœå‹™ï¼š

   ```bash
   cargo run --bin convert_service
   cargo run --bin sensor_publisher
   cargo run --bin sensor_subscriber
   ```

ç¾åœ¨ï¼Œæ©Ÿå™¨ 1 ä¸Šçš„ client å°‡èƒ½å¤ æŸ¥è©¢æ©Ÿå™¨ 2 ä¸Šçš„ `convert_service`ï¼Œè€Œæ©Ÿå™¨ 2 ä¸Šçš„ `sensor_subscriber` æœƒæ¥æ”¶åˆ°åŒä¸€å°æ©Ÿå™¨ä¸Š `sensor_publisher` ç™¼ä½ˆçš„è³‡æ–™ï¼Œæ•´å€‹éç¨‹é€éå…¬å…±è·¯ç”±å™¨å®Œæˆã€‚

---

## å›é¡§

* **å¤šé€²ç¨‹å¾®æœå‹™**ï¼šZenoh è®“å»ºç«‹å¤šé€²ç¨‹çš„åˆ†æ•£å¼ç³»çµ±è®Šå¾—å®¹æ˜“ã€‚
* **æœå‹™ç™¼ç¾**ï¼šZenoh æä¾›å…©ç¨®ä¸»è¦çš„ç™¼ç¾æ¨¡å¼ï¼š

  * **é»å°é»æ¨¡å¼ (é€éå¤šæ’­ä¾†æ‰¾å°‹)** ï¼šç°¡å–®ï¼Œç„¡å–®é»æ•…éšœï¼Œä½†å¯èƒ½é€ æˆç¶²è·¯å™ªéŸ³ã€‚
  * **è·¯ç”±å™¨æ¨¡å¼**ï¼šé›†ä¸­å¼ç™¼ç¾ï¼Œæ›´å¯æ“´å±•ï¼Œé¿å… multicastã€‚
* **é€šè¨Šæ¨¡å¼**ï¼šPub/Sub èˆ‡ Query/Reply æ¨¡å¼åœ¨æ‰€æœ‰æ¨¡å¼ä¸‹éƒ½èƒ½é †æš¢é‹ä½œã€‚
* **ä½ç½®é€æ˜æ€§**ï¼šZenoh æä¾›ä½ç½®é€æ˜æ€§ï¼Œä½¿æœå‹™è·¨ç¶²è·¯é€šè¨Šå°±åƒåœ¨åŒä¸€ç¶²è·¯ä¸­ä¸€æ¨£ã€‚ä½¿ç”¨è€…åªè¦å°ˆæ³¨åœ¨è¨­å®šè³‡æ–™çš„Key Expressionå°±å¯ä»¥æ‰¾åˆ°å°æ‡‰çš„æœå‹™ã€‚
