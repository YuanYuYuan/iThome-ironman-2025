# ğŸ¦€ ç”¨ Rust ä¾†æ’°å¯«ä¸€å€‹ Zenoh å¾®æœå‹™

ä»Šå¤©ï¼Œæˆ‘å€‘å°‡é€éæ’°å¯«ä¸€å€‹å°å‹æ‡‰ç”¨ç¨‹å¼ï¼Œä¾†ç†Ÿæ‚‰å¦‚ä½•åœ¨ Zenoh ä¸­æ“ä½œ **Session**ã€‚

Zenoh æ˜¯ä¸€å€‹è¨­è¨ˆç”¨æ–¼åˆ†æ•£å¼ç³»çµ±çš„ **ç™¼å¸ƒ/è¨‚é–±/æŸ¥è©¢** é€šè¨Šå”å®šï¼Œèƒ½å¤ å¾é›²ç«¯å»¶ä¼¸åˆ°é‚Šç·£è£ç½®ã€‚
åªéœ€å¹¾è¡Œ Rust ç¨‹å¼ç¢¼ï¼Œå°±å¯ä»¥å»ºç«‹åŠŸèƒ½å¼·å¤§çš„å¾®æœå‹™ï¼Œä¸¦åœ¨å„ç¨®ç¶²è·¯æ‹“æ’²ä¸­ç„¡ç¸«æºé€šã€‚

åœ¨é€™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å€‘å°‡æ’°å¯«ä¸€å€‹å–®ä¸€çš„ Zenoh ç¯€é»ï¼Œä¸¦å…·å‚™ä»¥ä¸‹åŠŸèƒ½ï¼š

* ä½¿ç”¨æŸ¥è©¢æä¾›å…©å€‹ **æœå‹™**ï¼ˆecho èˆ‡ convertï¼‰
* ç™¼å¸ƒ **æ„Ÿæ¸¬å™¨è³‡æ–™**ï¼ˆæº«åº¦ï¼‰
* è¨‚é–± **æ„Ÿæ¸¬å™¨è³‡æ–™** çš„æ›´æ–°
* ä½œç‚º **å®¢æˆ¶ç«¯** æŸ¥è©¢è‡ªèº«çš„æœå‹™

é€™æ¨£ä¸€ä¾†ï¼Œå®ƒå°±æˆç‚ºä¸€å€‹å®Œæ•´è‡ªè¶³çš„ **Zenoh å¾®æœå‹™**ã€‚

---

## ç’°å¢ƒè¨­å®š

å»ºç«‹ä¸€å€‹æ–°çš„å°ˆæ¡ˆï¼š

```bash
cargo new micro-service
```

ä¿®æ”¹ `Cargo.toml`ï¼š

```toml
[dependencies]
zenoh = "1.0.0"
tokio = { version = "1", features = ["full"] }
```

---

## å®Œæ•´ç¨‹å¼ç¢¼

æ¥ä¸‹ä¾†ä¿®æ”¹ `_src/main.rs_`ã€‚


```rust
// å°å…¥ Zenoh é€šè¨ŠåŠéåŒæ­¥æ“ä½œæ‰€éœ€çš„æ¨¡çµ„
use zenoh::Config;
use tokio::time::{sleep, Duration};

/// Zenoh å¤šæœå‹™ç¯€é»çš„ä¸»è¦é€²å…¥é»
/// æ­¤æ‡‰ç”¨å±•ç¤ºå„ç¨® Zenoh æ¨¡å¼ï¼š
/// - Queryable æœå‹™ï¼ˆecho å’Œ convertï¼‰
/// - ç™¼ä½ˆ/è¨‚é–±æ¨¡å¼ï¼ˆPub/Subï¼‰
/// - å®¢æˆ¶ç«¯æŸ¥è©¢
#[tokio::main]
async fn main() {
    // ä½¿ç”¨é è¨­è¨­å®šåˆå§‹åŒ– Zenoh session
    // Session æ˜¯æ‰€æœ‰ Zenoh æ“ä½œçš„ä¸»è¦å…¥å£
    let session = zenoh::open(Config::default()).await.unwrap();
    println!("Zenoh å¤šæœå‹™ç¯€é»å•Ÿå‹•ï¼");

    // -----------------------------
    // Echo æœå‹™
    // -----------------------------
    // å®£å‘Šä¸€å€‹å¯æŸ¥è©¢æœå‹™ï¼Œå›æ‡‰ "service/echo" çš„è«‹æ±‚
    // æ­¤æœå‹™æœƒç°¡å–®åœ°å›å‚³æ”¶åˆ°çš„è¨Šæ¯
    let echo = session.declare_queryable("service/echo").await.unwrap();
    tokio::spawn(async move {
        // æŒçºŒç›£è½å‚³å…¥çš„æŸ¥è©¢
        while let Ok(query) = echo.recv_async().await {
            // å¾æŸ¥è©¢ä¸­æå–è¨Šæ¯å…§å®¹
            let msg = query.payload().map(|p| p.try_to_string().unwrap_or_default().to_string()).unwrap_or_default();
            println!("[Echo æœå‹™] æ”¶åˆ°: {}", msg);

            // å›æ‡‰æŸ¥è©¢ï¼Œå›å‚³ echo å¾Œçš„è¨Šæ¯
            query.reply(query.key_expr().clone(), format!("Echo: {}", msg))
                .await.unwrap();
        }
    });

    // -----------------------------
    // äºŒé€²ä½è½‰æ›æœå‹™
    // -----------------------------
    // å®£å‘Šä¸€å€‹å¯æŸ¥è©¢æœå‹™ï¼Œå°‡æ•¸å­—è½‰æ›ç‚ºäºŒé€²ä½æ ¼å¼
    let convert = session.declare_queryable("service/convert").await.unwrap();
    tokio::spawn(async move {
        // æŒçºŒç›£è½å‚³å…¥çš„æŸ¥è©¢
        while let Ok(query) = convert.recv_async().await {
            // å¾æŸ¥è©¢ä¸­æå–è¨Šæ¯å…§å®¹
            let msg = query.payload().map(|p| p.try_to_string().unwrap_or_default().to_string()).unwrap_or_default();
            println!("[Binary Convert æœå‹™] æ”¶åˆ°: {}", msg);

            // å˜—è©¦è§£æè¨Šæ¯ç‚ºæ•´æ•¸ï¼Œä¸¦è½‰æ›ç‚ºäºŒé€²ä½
            // è‹¥è§£æå¤±æ•—ï¼Œå›å‚³éŒ¯èª¤è¨Šæ¯
            let reply = msg.parse::<i64>()
                .map(|v| format!("{} çš„äºŒé€²ä½æ ¼å¼ç‚º 0b{:b}", v, v))
                .unwrap_or_else(|_| "éŒ¯èª¤ï¼šä¸æ˜¯æœ‰æ•ˆçš„æ•´æ•¸".into());

            // å›æ‡‰æŸ¥è©¢ï¼Œå‚³å›äºŒé€²ä½è½‰æ›çµæœ
            query.reply(query.key_expr().clone(), reply).await.unwrap();
        }
    });

    // -----------------------------
    // Sensor ç™¼ä½ˆè€…
    // -----------------------------
    // å®£å‘Šä¸€å€‹ç™¼ä½ˆè€…ï¼Œç”¨æ–¼æ¨¡æ“¬æº«åº¦æ„Ÿæ¸¬å™¨è³‡æ–™
    // æ­¤ç™¼ä½ˆè€…å°‡æº«åº¦è³‡æ–™ç™¼ä½ˆåˆ° "sensor/temperature" ä¸»é¡Œ
    let publisher = session.declare_publisher("sensor/temperature").await.unwrap();
    tokio::spawn(async move {
        // åˆå§‹åŒ–æº«åº¦å€¼
        let mut value = 25.0;
        loop {
            // æ ¼å¼åŒ–ä¸¦ç™¼ä½ˆæº«åº¦è³‡æ–™
            let msg = format!("Temp = {:.1}", value);
            publisher.put(msg.clone()).await.unwrap();
            println!("[Publisher] ç™¼ä½ˆ: {}", msg);

            // æ¨¡æ“¬æº«åº¦è®ŠåŒ–ï¼Œç•¥å¾®å¢åŠ 
            value += 0.1;
            // ç­‰å¾… 2 ç§’å†ç™¼ä½ˆä¸‹ä¸€ç­†è³‡æ–™
            sleep(Duration::from_secs(2)).await;
        }
    });

    // -----------------------------
    // è¨‚é–±è€…
    // -----------------------------
    // å®£å‘Šä¸€å€‹è¨‚é–±è€…ï¼Œç›£è½æ‰€æœ‰æ„Ÿæ¸¬å™¨è³‡æ–™ï¼Œä½¿ç”¨é€šé…ç¬¦æ¨¡å¼
    // "sensor/**" æœƒåŒ¹é…ä»»ä½•ä»¥ "sensor/" é–‹é ­çš„ key expression
    let subscriber = session.declare_subscriber("sensor/**").await.unwrap();
    tokio::spawn(async move {
        // æŒçºŒç›£è½æ„Ÿæ¸¬å™¨ä¸»é¡Œçš„ç™¼ä½ˆè³‡æ–™
        while let Ok(sample) = subscriber.recv_async().await {
            // å–å‡º payload ä¸¦é¡¯ç¤ºå°æ‡‰çš„ä¸»é¡Œ key
            let payload = sample.payload().try_to_string().unwrap_or_default().to_string();
            println!("[Subscriber] '{}' -> {}", sample.key_expr(), payload);
        }
    });

    // -----------------------------
    // å®¢æˆ¶ç«¯å®šæœŸæŸ¥è©¢
    // -----------------------------
    // å»ºç«‹ä¸€å€‹å®¢æˆ¶ç«¯ä»»å‹™ï¼Œå®šæœŸæŸ¥è©¢æœå‹™
    // å±•ç¤º Zenoh çš„è«‹æ±‚-å›æ‡‰æ¨¡å¼
    tokio::spawn({
        let session = session.clone();
        async move {
            // ç­‰å¾…æœå‹™å•Ÿå‹•å®Œæˆï¼Œå†ç™¼é€æŸ¥è©¢
            sleep(Duration::from_secs(5)).await;

            let mut counter = 0;
            loop {
                counter += 1;
                println!("[Client] ç™¼é€æŸ¥è©¢ #{}", counter);

                // æŸ¥è©¢ echo æœå‹™
                let replies = session.get("service/echo")
                    .payload(format!("Hello Zenoh! #{}", counter))
                    .await.unwrap();

                // è™•ç†æ‰€æœ‰ echo æœå‹™å›è¦†
                while let Ok(reply) = replies.recv_async().await {
                    if let Ok(sample) = reply.result() {
                        println!("[Client] Echo å›è¦†: {}", sample.payload().try_to_string().unwrap());
                    }
                }

                // éå¢æ•´æ•¸ä¸¦æŸ¥è©¢ convert æœå‹™
                let test_value = 42 + counter;
                let replies = session.get("service/convert")
                    .payload(test_value.to_string())
                    .await.unwrap();

                // è™•ç† convert æœå‹™æ‰€æœ‰å›è¦†
                while let Ok(reply) = replies.recv_async().await {
                    if let Ok(sample) = reply.result() {
                        println!("[Client] Convert å›è¦†: {}", sample.payload().try_to_string().unwrap());
                    }
                }

                // ç­‰å¾… 3 ç§’å¾Œå†ç™¼é€ä¸‹ä¸€æ‰¹æŸ¥è©¢
                sleep(Duration::from_secs(3)).await;
            }
        }
    });

    // ä¿æŒä¸»åŸ·è¡Œç·’å­˜æ´»ï¼Œä»¥å…è¨±æ‰€æœ‰ spawned ä»»å‹™æŒçºŒé‹è¡Œ
    // ç„¡é™è¿´åœˆé˜²æ­¢ç¨‹å¼çµæŸ
    loop {
        sleep(Duration::from_secs(60)).await;
    }
}
```

---

## æ¶æ§‹åœ–

ä»¥ä¸‹å±•ç¤º Zenoh å¾®æœå‹™ç¯€é»å…§å„å€‹å…ƒä»¶å¦‚ä½•å”ä½œï¼š

```txt
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚           Zenoh å¾®æœå‹™ç¯€é»                â”‚
          â”‚                                           â”‚
          â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
Client â”€â”€â”€â”¼â”€â”€â–¶â”‚ Echo æœå‹™    â”‚     â”‚ Convert æœå‹™ â”‚â—€â”€â”€â”¼â”€â”€ Client
(æŸ¥è©¢)    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  (æŸ¥è©¢)
          â”‚                                           â”‚
          â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
Publisher â”€â”€â”€â–¶â”‚ æº«åº¦ç™¼ä½ˆå™¨   â”‚â”€â”€â”€â”€â–¶â”‚ è¨‚é–±è€…ç›£è½å™¨ â”‚â”€â”€â”€â”¼â”€â”€ æ§åˆ¶å°
 (ç™¼ä½ˆ)   â”‚   â”‚              â”‚     â”‚              â”‚   â”‚ (ç´€éŒ„è³‡æ–™)
          â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

* **Echo æœå‹™**ï¼šå›å‚³ `"Echo: <msg>"`ã€‚
* **Convert æœå‹™**ï¼šè§£ææ•¸å­—ä¸¦å›å‚³äºŒé€²ä½è¡¨ç¤ºã€‚
* **ç™¼ä½ˆè€… (Publisher)**ï¼šæŒçºŒç™¼é€æº«åº¦æ•¸æ“šã€‚
* **è¨‚é–±è€… (Subscriber)**ï¼šå³æ™‚ç›£è½æº«åº¦æ›´æ–°ã€‚
* **å®¢æˆ¶ç«¯ (Client)**ï¼šå®šæœŸæŸ¥è©¢æœå‹™ä»¥å±•ç¤ºè«‹æ±‚-å›æ‡‰æ¨¡å¼ã€‚


---

## é‹è¡Œå¾®æœå‹™


åŸ·è¡Œæ‡‰ç”¨ç¨‹å¼ï¼š

```bash
cargo run
```

è¼¸å‡ºç¯„ä¾‹ï¼š

```
Zenoh å¤šæœå‹™ç¯€é»å•Ÿå‹•ï¼
[Publisher] ç™¼ä½ˆ: Temp = 25.0
[Subscriber] 'sensor/temperature' -> Temp = 25.0
[Publisher] ç™¼ä½ˆ: Temp = 25.1
[Subscriber] 'sensor/temperature' -> Temp = 25.1
[Publisher] ç™¼ä½ˆ: Temp = 25.2
[Subscriber] 'sensor/temperature' -> Temp = 25.2
[Client] ç™¼é€æŸ¥è©¢ #1
[Echo æœå‹™] æ”¶åˆ°: Hello Zenoh! #1
[Client] Echo å›è¦†: Echo: Hello Zenoh! #1
[Binary Convert æœå‹™] æ”¶åˆ°: 43
[Client] Convert å›è¦†: 43 çš„äºŒé€²ä½æ ¼å¼ç‚º 0b101011
[Publisher] ç™¼ä½ˆ: Temp = 25.3
[Subscriber] 'sensor/temperature' -> Temp = 25.3
[Client] ç™¼é€æŸ¥è©¢ #2
[Echo æœå‹™] æ”¶åˆ°: Hello Zenoh! #2
[Client] Echo å›è¦†: Echo: Hello Zenoh! #2
[Binary Convert æœå‹™] æ”¶åˆ°: 44
[Client] Convert å›è¦†: 44 çš„äºŒé€²ä½æ ¼å¼ç‚º 0b101100
```

---

## å›é¡§

* **Pub/Sub** â€” æ¨¡æ“¬æ„Ÿæ¸¬å™¨æŒçºŒç™¼ä½ˆï¼Œè¨‚é–±è€…å³æ™‚æ¥æ”¶ã€‚
* **Query/Reply** â€” æœå‹™å¯å›æ‡‰å³æ™‚è«‹æ±‚ï¼ˆ`/service/echo`ã€`/service/convert`ï¼‰ã€‚
* **å®¢æˆ¶ç«¯æ•´åˆ** â€” ç¯€é»å¯ä»¥åƒå…¶ä»– peer ä¸€æ¨£æŸ¥è©¢è‡ªå·±çš„æœå‹™ã€‚
* **æ•´åˆå¾®æœå‹™ç¯€é»** â€” æ‰€æœ‰åŠŸèƒ½åœ¨å–®ä¸€ Rust ç¨‹å¼ä¸­é‹è¡Œï¼Œæ–¹ä¾¿æ“´å±•ã€‚

ä¹‹å¾Œæˆ‘å€‘æœƒå°‡é€™å€‹ç¯„ä¾‹æ‹†åˆ†æˆç¨ç«‹å¾®æœå‹™ï¼Œåœ¨ä¸åŒé€²ç¨‹ä¸­é‹è¡Œï¼Œæˆ–åˆ†æ•£åˆ°å¢é›†ã€‚è—‰æ­¤ä¾†å±•ç¤ºZenoh æœƒè‡ªå‹•è™•ç†ç™¼ç¾ã€è·¯ç”±èˆ‡è¨Šæ¯å‚³éã€‚æˆ‘å€‘ä¸‹ä¸€ç¯‡æ–‡ç« è¦‹ï¼
